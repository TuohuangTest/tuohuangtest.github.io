
<!doctype html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--> 	
<html lang="en"> 
<!--<![endif]-->
  <head>
    <meta charset="utf-8" />
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />	<!-- Force Latest IE rendering engine -->
    <title>UrbanAirship Android Received push with invalid authorization on platform GCM</title>

    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->


    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
    <link href="http://feeds2.feedburner.com/tu0huang" rel="alternate" title="Tuo" type="application/atom+xml" /> 
    <link rel="shortcut icon" href="/static/images/favicon.png" />

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 

    <link rel="stylesheet" href="/static/css/style.css">

    <!--[if IE 7]>
      <script src="/static/css/font-awesome-ie7.css"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">	
     

      <article class='fourteen columns' id="article-content" style="border: 0px solid red">

  <a id="avatar" class="four columns" style="width:100px;height:100px;" href="/"></a>

  <header class="eleven columns" id="article-header" style="margin-top:14px;">
    <h1>UrbanAirship Android Received push with invalid authorization on platform GCM</h1>
  </header>

  <div class='eleven columns gray' id="date-header" style="margin-bottom: 10px;">
    <p>
      Mar 19, 2014
    </p>

  </div>

  <div style="clear:both"/>
  <div class="fourteen columns" id="article-content">
    <p>I was trying integrate Urban Airship to an android application so that I could send push notification to all registered android devices via Google’s <a href="http://developer.android.com/google/gcm/index.html">GCM</a> (Google Cloud Messaging for Android) service.</p>

<p>Urban Airship does have a really good documentation about to how to set it up on Android: <a href="http://docs.urbanairship.com/build/android.html#setting-up-gcm-support-for-your-app">Android: Getting Started with Push</a>. So I followed the instruction above and integrated with android app locally. But when I try to test the push notification by going to <em>Messages</em> -&gt; <em>Test Push</em> in the left panel like following screenshot <img src="http://farm8.staticflickr.com/7155/13265323853_a0189bc83b_b.jpg" alt="Invalid Authorization on GCM" />.</p>

<p>It keeps saying <strong>Received push with invalid authorization on platform GCM</strong>.</p>

<h2 id="problem-breakdown">Problem breakdown</h2>

<p>I searched in google and found several same issues reported by people, e.g., <a href="https://support.urbanairship.com/customer/portal/questions/4449356-received-push-with-invalid-authorization-on-platform-gcm-in-urban-push-console">Received push with invalid authorization on platform GCM in Urban push console</a> and  <a href="https://support.urbanairship.com/customer/portal/questions/4690667-received-push-with-invalid-authorization-on-platform-gcm">Received push with invalid authorization on platform GCM</a>. The thing is that it works fine on iOS but not on Android, the kind-hearted guy from Urban Airship suggested to look through their <a href="https://support.urbanairship.com/customer/portal/articles/823114-gcm-troubleshooting-guide">GCM Troubleshooting Guide</a>. </p>

<p>Well, I did verify each steps illustrated in the troubleshooting guide, the api key, package, sender id and so on. Still no clue for it.I take a step back and think the problem clearly refers to “invalid authroization on platform GCM”, then it should be something wrong with GCM settings.</p>

<p>Here is the settings in google api console:<img src="http://farm4.staticflickr.com/3756/13265170335_69a45bd164_b.jpg" alt="Google API Console" /></p>

<p>There is SHA1 string and a package name for it, you have to make sure you have right SHA1 and package name from your app. Based on the documentation about <a href="https://developers.google.com/console/help/new/#usingkeys">Keys, access, security, and identity</a>. I need doublec check the apk generated should have same SHA1 and package name. To verify the SHA1 string, there is post in stackoverflow <a href="http://stackoverflow.com/questions/11331469/how-to-find-out-which-key-was-used-to-sign-an-app">How to find out which key was used to sign an app?</a></p>

<blockquote>

  <pre><code>2:35 ~/Desktop/frames/PushSample-debug-unaligned/META-INF $ keytool -printcert -file CERT.RSA
Owner: CN=Android Debug, O=Android, C=US
Issuer: CN=Android Debug, O=Android, C=US
Serial number: 517787d8
Valid from: Wed Apr 24 15:20:56 CST 2013 until: Fri Apr 17 15:20:56 CST 2043
Certificate fingerprints:
	 MD5:  9C:DC:4C:FA:5A:74:F0:83:9D:17:D8:3B:1A:C3:BD:E5
	 SHA1: 34:10:4F:F9:9D:63:7A:56:BE:94:AD:07:B3:80:3B:A1:EE:9A:E6:67
	 Signature algorithm name: SHA1withRSA
	 Version: 3
</code></pre>
</blockquote>

<p>and compare with the SHA1 string in <em>~/.android/debug.keystore</em>:</p>

<blockquote>

  <pre><code>12:36 ~/Desktop/frames/PushSample-debug-unaligned/META-INF $ keytool -list -keystore ~/.android/debug.keystore
Enter keystore password:android	
Keystore type: JKS
Keystore provider: SUN	
Your keystore contains 1 entry	
androiddebugkey, Apr 24, 2013, PrivateKeyEntry,
Certificate fingerprint (MD5): 9C:DC:4C:FA:5A:74:F0:83:9D:17:D8:3B:1A:C3:BD:E5
</code></pre>
</blockquote>

<p>The SHA1 string is the same, then how about the package name? </p>

<p>Refer to this post <a href="http://stackoverflow.com/questions/6289149/resolving-the-package-name-of-android-apk">Resolving the package name of Android APK</a>, I’m able to print the apk infos about package name:</p>

<blockquote>

  <pre><code>12:40 ~/Desktop/frames $ /Users/tuo/Documents/SDKS/adt-bundle-mac-x86_64-20131030/sdk/build-tools/android-4.4/aapt  dump badging PushSample-debug-unaligned.apk
package: name='com.reigndesign.rdapp1' versionCode='1' versionName='1.0'
sdkVersion:'7'
targetSdkVersion:'19'
uses-permission:'android.permission.INTERNET'
...
</code></pre>
</blockquote>

<p>Also the package name matches.</p>

<p>Here is the question the package name and SHA1 are correct, then how come it still says “<em>invalid authorization</em>” ?	</p>

<h2 id="android-key-vs-server-key">Android key vs Server key</h2>

<p>My instinct that accumulated from countless red-eye days of programming told me that I should rollback everything and start walk through the documentation as carefully as I can from scratch.</p>

<p>And I did find out why.</p>

<p>In one section about <a href="http://docs.urbanairship.com/build/android.html#get-your-api-key-from-google">Get your API Key from Google</a>, it says:</p>

<blockquote>

  <pre><code>4.Generate an API Key	
	A. Click on the text where it says “Google Cloud Messaging for Android” in the image above.		
	B. This takes your to the Google APIs page. Click on API Access.		
	C. Urban Airship takes care of API Access authorization for you, so you do not need to create an OAuth 2.0 client ID.		
	D. Click on “Create a new Server key...” to generate your API Key.		
	E. Do not specify any IP addresses in the form, and click “Create”
</code></pre>
</blockquote>

<p>What I realized is that holy <em>**</em>, it is god dammned <em>Server key</em> instead of <em>Android key</em>. I did go back and take a detail look at what android key is about:</p>

<blockquote>

  <pre><code>Create an Android key and configure allowed Android applications
	This key can be deployed in your Android application. API requests are sent directly to Google from your client Android device. Google verifies that each request originates from an Android application that matches one of the certificate SHA1 fingerprints and package names listed below. You can discover the SHA1 fingerprint of your developer certificate using the following command:
	keytool -list -v -keystore mystore.keystore
</code></pre>
</blockquote>

<p>Then I understand it better. Because ubarn airship is acting on our app’s behalf dealing with GCM platform rather than let our app do the dirty job. So serve key makes sense to me now.</p>

<p>So I created a <em>Server key</em> and try it again, no more errors.</p>

<p><img src="http://farm8.staticflickr.com/7224/13265325123_72842e53a3_b.jpg" alt="Server key" /></p>


  </div>
  <hr style="visibility:hidden;"/>
  
  <!--<footer class="ten columns">
    <p id='follow'>
       Follow me on <a href="http://twitter.com/tu0huang">Twitter</a> &
       <a href="http://weibo.com/tu0huang">Weibo</a>	   
    </p>
  </footer> -->
</article>

<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style fourteen columns" style="margin-bottom: 11px;">
	<a class="addthis_counter addthis_pill_style"></a>
</div>
<script type="text/javascript">var addthis_config = {"data_track_addressbar":true};</script>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-50f9651243f1723a"></script>
<!-- AddThis Button END -->
<div style="margin-bottom:10px;"/>
<div id="disqus_thread" class="fourteen columns"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'tuo'; // required: replace example with your forum shortname  
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    </div>
  </body>
</html> 
