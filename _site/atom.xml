<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
 
 <title>Tuo</title>
 <link href="http://tuohuang.info/atom.xml" rel="self"/>
 <link href="http://tuohuang.info/"/>
 <updated>2014-08-31T19:08:39+08:00</updated>
 <id>http://tuohuang.info/</id>
 <author>
   <name>Tuo</name>
   <email>clarkhtse@gmail.com</email>
 </author>

 
 <entry>
   <title>在Parallels Desktop 9运行Windows 8 Phone模拟器</title>
   <link href="http://tuohuang.info/windows-phone-8-emulator-on-parallels-desktop-9-mac"/>
   <updated>2014-07-19T12:17:52+08:00</updated>
   <id>http://tuohuang.info/windows-phone-8-emulator-on-parallels-desktop-9-mac</id>
   <content type="html">&lt;p&gt;在Parallels Desktop 9中跑起来Windows Phone 8的模拟器来进行开发， 准备工作大概可以分为几部分：&lt;/p&gt;

&lt;h2 id=&quot;section&quot;&gt;操作系统&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;Windows 8 64位 Pro版本的iso
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&quot;section-1&quot;&gt;开发工具&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;http://www.microsoft.com/en-US/download/details.aspx?id=30664&quot;&gt;Microsoft Visual Studio Express 2012 for Windows 8&lt;/a&gt;	选择下载VS2012_WINEXP_enu.ISO就好&lt;/p&gt;

&lt;h2 id=&quot;windows-phone-sdk-80&quot;&gt;Windows Phone SDK 8.0&lt;/h2&gt;

&lt;p&gt;建议直接下载iso文件，当然英文最好: &lt;a href=&quot;http://download.microsoft.com/download/9/3/8/938A5074-461F-4E3D-89F4-5CE2F42C1E36/fulltril30/iso/wpsdkv80_enu1.iso&quot;&gt;Windows Phone SDK 8.0 iso&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;section-2&quot;&gt;安装顺序&lt;/h2&gt;
&lt;pre&gt;&lt;code&gt;windows 8  -&amp;gt; visual studio -&amp;gt; wp8 sdk
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&quot;parallel-desktop-9&quot;&gt;Parallel Desktop 9&lt;/h2&gt;

&lt;p&gt;具体安装流程可以参考&lt;a href=&quot;http://msdn.microsoft.com/zh-cn/library/windows/apps/jj945424.aspx&quot;&gt;使用 Parallels Desktop 在 Mac 上安装 Windows 和开发工具&lt;/a&gt; 这里有一点需要注意的是，在[步骤 2：设置 Parallels Desktop]中第六步之后，你还需要选中设置面板中第二个tab[Options],下面的左侧的[Optimization]，右侧内容中[Enable nested virtualization]。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://cloud.githubusercontent.com/assets/491610/3633860/411b570c-0f00-11e4-947c-61cc1cbf1e80.png&quot; alt=&quot;Enable nested virtualization&quot; /&gt;&lt;/p&gt;

&lt;p&gt;在系统安装完毕之后，我们需要打开Hyper-V功能，这是能让模拟器能跑起来的重要条件。&lt;/p&gt;

&lt;p&gt;依次打开 &lt;code&gt;Control Panel&lt;/code&gt; -&amp;gt; &lt;code&gt;Programs and Features&lt;/code&gt; -&amp;gt; &lt;code&gt;Turn Windows features on or off&lt;/code&gt; -&amp;gt; tick &lt;code&gt;Hyper-V&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://cloud.githubusercontent.com/assets/491610/3633861/4cf12098-0f00-11e4-8ee4-c498a98e9526.png&quot; alt=&quot;Hyper-v&quot; /&gt;&lt;/p&gt;

&lt;p&gt;然后重启电脑。&lt;/p&gt;

&lt;p&gt;接下来就是用ultraiso依次加载和安装visual studio和windows phone 8 sdk。&lt;/p&gt;

&lt;p&gt;到wp8 sdk安装完毕之后，你应该能看到如下的界面，那就表示安装成功，你可以直接打开vs跑起来了。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://cloud.githubusercontent.com/assets/491610/3633863/66cdbef4-0f00-11e4-8e19-30d2dd129595.png&quot; alt=&quot;WP8 SDK&quot; /&gt;&lt;/p&gt;

&lt;p&gt;接下来就简单了，跑起来Hello World.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://cloud.githubusercontent.com/assets/491610/3633873/21cd0b1a-0f01-11e4-94c1-d68667859675.png&quot; alt=&quot;Hello World&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;references&quot;&gt;References&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;http://www.cnblogs.com/fengbeihong/archive/2013/01/28/2880179.html&quot;&gt;Windows Phone 8 开发环境搭建&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;http://kb.parallels.com/en/115211&quot;&gt;PD9: Running Windows 8 Phone emulator in the Windows 8 virtual machine&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;http://msdn.microsoft.com/zh-cn/library/windows/apps/jj945424.aspx&quot;&gt;使用 Parallels Desktop 在 Mac 上安装 Windows 和开发工具&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

</content>
 </entry>
 
 <entry>
   <title>Unity 2D Gradient Background Transition</title>
   <link href="http://tuohuang.info/unity-2d-gradient-background"/>
   <updated>2014-06-21T13:31:22+08:00</updated>
   <id>http://tuohuang.info/unity-2d-gradient-background</id>
   <content type="html">&lt;p&gt;When develop 2D games in Unity, sometime we want to make some transition on day-night cycle(e.g. sky color change)&lt;/p&gt;

&lt;p&gt;So I have one design for start state of dawn like following: &lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://cloud.githubusercontent.com/assets/491610/3633961/ba10f934-0f08-11e4-9f9c-77c34bdbe32c.png&quot; alt=&quot;dawn start sky color&quot; /&gt;&lt;/p&gt;

&lt;p&gt;(bottom color: fe805e, top: 527fc1)&lt;/p&gt;

&lt;p&gt;and the end state of dawn: &lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://cloud.githubusercontent.com/assets/491610/3633960/ba1003d0-0f08-11e4-8e5b-2b5d8c4f9393.png&quot; alt=&quot;dawn end sky color&quot; /&gt;&lt;/p&gt;

&lt;p&gt;(bottom color: fa8856, top: 7ae0ec)&lt;/p&gt;

&lt;p&gt;The final effect should be like this: &lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://cloud.githubusercontent.com/assets/491610/3633977/61552796-0f0a-11e4-80ea-f96b879c48ec.gif&quot; alt=&quot;transition&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;graident&quot;&gt;Graident&lt;/h2&gt;

&lt;p&gt;To achieve the gradient background, we need to apply a new gradient shader. The shader would accept one main texture, and two colors.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;csharp&quot;&gt; 
&lt;span class=&quot;n&quot;&gt;Shader&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Custom/Gradient&amp;quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;Properties&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;	[PerRendererData]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_MainTex&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Sprite Texture&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2D&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;white&amp;quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;_Color&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Bottom Color&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Color&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;_Color2&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Top Color&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Color&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;_Scale&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Scale&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Float&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
 
&lt;span class=&quot;n&quot;&gt;SubShader&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Tags&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Queue&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Background&amp;quot;&lt;/span&gt;  &lt;span class=&quot;s&quot;&gt;&amp;quot;IgnoreProjector&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;True&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;LOD&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;
 
    &lt;span class=&quot;n&quot;&gt;ZWrite&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;On&lt;/span&gt;
 
    &lt;span class=&quot;n&quot;&gt;Pass&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;CGPROGRAM&lt;/span&gt;
        &lt;span class=&quot;cp&quot;&gt;#pragma vertex vert  &lt;/span&gt;
        &lt;span class=&quot;cp&quot;&gt;#pragma fragment frag&lt;/span&gt;
        &lt;span class=&quot;err&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;UnityCG.cginc&amp;quot;&lt;/span&gt;
 
        &lt;span class=&quot;n&quot;&gt;fixed4&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_Color&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;fixed4&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_Color2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;fixed&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;_Scale&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
 
        &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;v2f&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;float4&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pos&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SV_POSITION&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;fixed4&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;col&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;COLOR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;
 
        &lt;span class=&quot;n&quot;&gt;v2f&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;vert&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;appdata_full&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;v2f&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;o&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;o&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pos&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mul&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;UNITY_MATRIX_MVP&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;vertex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;o&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;col&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lerp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_Color&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_Color2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;texcoord&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//            o.col = half4( v.vertex.y, 0, 0, 1);&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;o&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
       
 
        &lt;span class=&quot;n&quot;&gt;float4&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;frag&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;v2f&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;COLOR&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;float4&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;col&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;ENDCG&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Then create a material with that shader and assign the mat to sprite render, finally in script:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;csharp&quot;&gt; 
&lt;span class=&quot;n&quot;&gt;sRender&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;material&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SetColor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;_Color&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Color&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;black&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// the bottom color&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;sRender&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;material&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SetColor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;_Color2&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Color&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;white&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// the top color&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2 id=&quot;transition&quot;&gt;Transition&lt;/h2&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;csharp&quot;&gt; 

&lt;span class=&quot;k&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;duration&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1.0f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SpriteRenderer&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sRender&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;c1&quot;&gt;// Update is called once per frame&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;Color&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;HexToColor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;hex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;kt&quot;&gt;byte&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;r&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;byte&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Parse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;hex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Substring&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Globalization&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NumberStyles&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HexNumber&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;kt&quot;&gt;byte&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;g&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;byte&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Parse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;hex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Substring&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Globalization&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NumberStyles&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HexNumber&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;kt&quot;&gt;byte&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;byte&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Parse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;hex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Substring&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Globalization&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NumberStyles&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HexNumber&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;Color32&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;g&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;255&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;


	&lt;span class=&quot;k&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;Update&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lerp&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Mathf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PingPong&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;duration&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;duration&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;sRender&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;material&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SetColor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;_Color&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Color&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Lerp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HexToColor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;fe805e&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HexToColor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;fa8856&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;lerp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//bottom&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;sRender&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;material&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SetColor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;_Color2&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Color&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Lerp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HexToColor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;527fc1&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HexToColor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;7ae0ec&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;lerp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//top&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

</content>
 </entry>
 
 <entry>
   <title>TPLink WR720N刷OpenWrt - 修砖</title>
   <link href="http://tuohuang.info/tplink-wr720n-openwrt"/>
   <updated>2014-05-04T17:06:50+08:00</updated>
   <id>http://tuohuang.info/tplink-wr720n-openwrt</id>
   <content type="html">&lt;p&gt;    一年一度的NBA季后赛开始了，今年季后赛第一轮更是尤其精彩，连续两天五场抢七，还有惊心动魄的火箭打开拓者，看的我这个篮球迷如痴如醉。但是比赛一般都在早上，而且比赛时间还挺长的，如果看完了再去上班肯定稳稳的迟到，如果晚上回来想看录像了又觉得网速那个点又慢，而且我对国内的解说说实话也不是感冒，看英文的可能还舒服点，没那么吵吵。所以我希望在比赛结束了（一般都是中午左右）， 在上班的间隙我把种子下好，然后上传到比如我家里路由器暴露在外面上某个网址上，可以利用迅雷下载的速度优势，在下班回家前就把高清录像下好了。我回到家里的时候，直接从电脑上stream路由器的存储媒介（通常是硬盘）上下好的视频。&lt;/p&gt;

&lt;p&gt;    选路由器是因为我不可能把家里的笔记本一直开一天吧，这个也太浪费了把。而且路由器本来就是在那开一天的，倒也不浪费。所以怎么捯饬这玩意可以达到我上面美好的愿望了？就是&lt;em&gt;&lt;a href=&quot;http://openwrt.org/&quot;&gt;OpenWrt&lt;/a&gt;&lt;/em&gt;了。简单的说，我将要干的事情就是把路由器出厂自带的固件也换成Openwrt。我发现网上有不少关于这方面的教程（大部分还是703N，有点老了），但是没有讲的很清楚从头到尾很直白的那种，这篇博客就是记录自己刷机的过程&lt;/p&gt;

&lt;h2 id=&quot;section&quot;&gt;首次刷机尝试&lt;/h2&gt;

&lt;p&gt;    手头有的东西名目:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;* 一个很早之前买的TPLink WR720N迷你路由
* 一根microUSB线
* 网线
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;    那选择WR720N也是因为首先它便宜啊，而且它自带一个USB口(方便挂载外设），一个microUSB口，一个LAN口，还有一个WAN/LAN口， 真实麻雀虽小，五脏俱全。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://farm8.staticflickr.com/7383/13916298737_4feb69fda5_b.jpg&quot; alt=&quot;TPLink WR720N&quot; /&gt;&lt;/p&gt;

&lt;p&gt;    而且Openwrt官方已经添加了对WR720N专有固件的支持(你可以找到openwrt支持的所有硬件列表&lt;a href=&quot;http://wiki.openwrt.org/toh/start&quot;&gt;Table of Hardware - Router type&lt;/a&gt;)，使得刷机愈加容易。你需要做的就是去这个地址&lt;a href=&quot;http://downloads.openwrt.org/snapshots/trunk/ar71xx/&quot;&gt;http://downloads.openwrt.org/snapshots/trunk/ar71xx/&lt;/a&gt;找到&lt;a href=&quot;http://downloads.openwrt.org/snapshots/trunk/ar71xx/openwrt-ar71xx-generic-tl-wr720n-v3-squashfs-factory.bin&quot;&gt;openwrt-ar71xx-generic-tl-wr720n-v3-squashfs-factory.bin&lt;/a&gt;和&lt;a href=&quot;http://downloads.openwrt.org/snapshots/trunk/ar71xx/openwrt-ar71xx-generic-tl-wr720n-v3-squashfs-sysupgrade.bin&quot;&gt;openwrt-ar71xx-generic-tl-wr720n-v3-jffs2-sysupgrade.bin&lt;/a&gt;，然后下载到本地。&lt;/p&gt;

&lt;p&gt;    接下来就是登陆路由器,720N就是192.168.1.253,然后找到左侧最下面的&lt;em&gt;升级&lt;/em&gt;，选取将本地刚刚下好的factory.bin(不是sysupgrade.bin)）升级,耐心等重启之后就可以了。&lt;/p&gt;

&lt;p&gt;    为什么这里是factory而不是sysupgrade了？ &lt;a href=&quot;http://wiki.openwrt.org/doc/faq/before.installation&quot;&gt;FAQ before installing OpenWrt&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;What is the difference between the different image formats?&lt;/p&gt;

  &lt;p&gt;a factory image is one built for the bootloader flasher or stock software flasher&lt;/p&gt;

  &lt;p&gt;sysupgrade image (previously named trx image) is designed to be flashed from within openwrt itself&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;section-1&quot;&gt;刷成砖头了&lt;/h2&gt;
&lt;p&gt;    是的，应该很简单，应该木有问题的，但是很不幸我的刷成了砖头了，ping不通，IP地址无效，重设了N遍都木有任何反应。&lt;img class=&quot;emoji&quot; title=&quot;:scream:&quot; alt=&quot;:scream:&quot; src=&quot;https://assets.github.com/images/icons/emoji/scream.png&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; /&gt; &lt;/p&gt;

&lt;p&gt;    怎么办了？我大概了解下路由器启动过程，一般路由器都有一个Flash卡（相当于电脑的硬盘，里面有你个操作系统文件等等），里面有你写好或者下好的固件.当路由器启动时，有一个启动引导程序uboot（相当于windows上BIOS),一般来收它会从Flash卡读取固件（相当于windows比如默认从硬盘上启动操作系统）并加载到内存中。&lt;/p&gt;

&lt;p&gt;    这里就是一般来说就是Flash卡中的固件已经损坏了，我们需要擦除里面已有固件信息，然后将原厂固件刷进去。但是这个怎么操作了，我们都进不去路由？&lt;/p&gt;

&lt;h2 id=&quot;ttl&quot;&gt;TTL修砖&lt;/h2&gt;
&lt;p&gt;    除了砸了之外还是有办法挽救的 - TTL线。 我也不太清楚这个具体原理，大概就是你需要找到路由器板子上的两个接口TP_IN和TP_OUT(可以用来接受和发送指令),这里相当于外设，然后与电脑(COM)进行串口通信。&lt;/p&gt;

&lt;p&gt;    但是笔记本木有COM端口了，需要将USB转换成COM端口，然后与路由器电路板上连接，接着使用串口通信的软件设置对应的串口号以及波特率，这样就可以发送指令到路由器电路板，从而修复固件。&lt;/p&gt;

&lt;p&gt;我们需要的东西:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;* USB转串口的TTL线, 可以从淘宝上买[USB转TTL模块](http://item.taobao.com/item.htm?_u=tc8grg404cf&amp;amp;id=14126761542)）
* 电烙铁 
* 杜邦线（用于焊接和连接USB模块）
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;就可以了。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://farm6.staticflickr.com/5335/14079877556_66a2f80fae.jpg&quot; alt=&quot;杜邦线&quot; /&gt;
&lt;img src=&quot;https://farm6.staticflickr.com/5348/13916363779_02f40ab666_z.jpg&quot; alt=&quot;电烙铁&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;section-2&quot;&gt;1. 接线&lt;/h4&gt;
&lt;p&gt;接下来就是拆机找到TP_IN和TP_OUT两个引脚。这个拆机还真有点技巧性。因为720N这个塑料外壳还真是一次性的，用蛮力的话盒子就没法用了，那么就不能插电源充电了，就只能是用microusb线充电了。但是因为引脚实在板子背面所以我们必须要将板子取出来。我想了一个办法就是拿烧红的刀直接去砍网口那边的两侧，这样一来板子可以取出来而且以后要是弄好了我还可以放回去，插电源充电也木有问题。
&lt;img src=&quot;https://farm8.staticflickr.com/7067/13916324949_fc86e9ee3a_b.jpg&quot; alt=&quot;TPLink WR720N BREAK IT DOWN&quot; /&gt;&lt;/p&gt;

&lt;p&gt;成功拆机了。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://farm6.staticflickr.com/5189/14099740901_82e05a8d63_b.jpg&quot; alt=&quot;WR720N breakitdown&quot; /&gt;&lt;/p&gt;

&lt;p&gt;如果你仔细看背面中间，就可以发现TP_IN和TP_OUT连个引脚，但是它们都非常小，这就使得焊接非常难。
&lt;img src=&quot;https://farm8.staticflickr.com/7327/14102965995_cf8dd4b512_b.jpg&quot; alt=&quot;TP_IN AND TP_OUT&quot; /&gt;			
使用电烙铁小心将杜邦线焊接到这两个接口上，另外一根线作为接地线GND随意焊接到哪都行，图方便的话直接焊接到USB接口外壳上也可以。&lt;/p&gt;

&lt;p&gt;最后将引出的杜邦线连接到USB转TTL模块上。这里USB模块上写着&lt;em&gt;黑GND, 白RXD,绿TXD&lt;/em&gt;.我们要做就是将引出的&lt;em&gt;TP_IN&lt;/em&gt;针连接到&lt;em&gt;白RXD&lt;/em&gt;上， &lt;em&gt;TP_OUT&lt;/em&gt;连接到&lt;em&gt;绿TXD&lt;/em&gt;口上。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://farm3.staticflickr.com/2933/13916358019_05c50fcd55_c.jpg&quot; alt=&quot;wired&quot; /&gt;
&lt;img src=&quot;https://farm8.staticflickr.com/7305/14103410134_f3715bfef0_c.jpg&quot; alt=&quot;wired gnd&quot; /&gt;
注意注意：千万别将TP_IN或者TP_OUT连接到VCC口上，不然直接就把板子给烧了。（我去，我最后不小心看花眼连接错了直接把板子给烧了，是的，程序员不能在困的时候干正事）&lt;/p&gt;

&lt;h4 id=&quot;section-3&quot;&gt;2. 安装驱动&lt;/h4&gt;
&lt;p&gt;你直接连接好线是不能直接用的，串口还是无法被识别出来。你需要下载对应的驱动，也就是PL2303 USB to TTL驱动， &lt;a href=&quot;http://www.prolific.com.tw/US/ShowProduct.aspx?p_id=229&amp;amp;pcid=41&quot;&gt;mac版&lt;/a&gt;以及&lt;a href=&quot;http://pan.baidu.com/s/1kTn1d6R&quot;&gt;windows版&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;给路由器供电，这里我们使用microUSB来供电，接下来就是去&lt;em&gt;设备管理器&lt;/em&gt;中查看&lt;em&gt;端口(COM和PT)&lt;/em&gt;下面有没有东西，如果有类似于&lt;em&gt;Prolific USB-to-Serial Comm port(COM4)&lt;/em&gt;，就表示识别成功。然后点击&lt;em&gt;属性&lt;/em&gt;将其波特率改成&lt;em&gt;115200&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://farm8.staticflickr.com/7395/13916387869_aa8288539c_c.jpg&quot; alt=&quot;linked&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;section-4&quot;&gt;3. 调试&lt;/h4&gt;
&lt;p&gt;到这一步就差不多可以干正事了，我们可以使用串口通信软件来发送指令来刷固件，这里用的是SecureCRT。很简单，我们创建一个串口连接，将其COM口设成设备管理器中显示的端口号，波特率设为115200.&lt;/p&gt;

&lt;p&gt;拔掉microUSB线，然后重新连上，你就可以看到SecureCRT中开始滚动了，你应该可以看到如下信息，没有反应的话，检查你得rx/tx是否接反了。&lt;/p&gt;

&lt;p&gt;是的，我们看到了uboot的引导信息。接下来就是怎么样打断其正常引导过程，因为Flash卡中的固件已经损坏了。但是我们不可能把Flash卡拔下来，把原厂库件刷进入，然后插回去重启。我们就需要告诉uboot从其他地方这里比如就是我们的电脑下载到flash卡中。 这里就可以配合tftp来实现从电脑上下载。为什么是tftp了？如果你后面进入了uboot输入模式，输入&lt;em&gt;help&lt;/em&gt;就可以看到其中有一个选项：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;tftpboot- boot image via network using TFTP protocol
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;可以理解为TFTP是uboot能理解的轻量级FTP.&lt;/p&gt;

&lt;p&gt;用网线一端连接路由器的WAN/LAN口，一端连接电脑。打开电脑,设置ip地址：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;IP: 192.168.1.3
Mask: 255.255.255.0
gateway/router: 空白 不要填 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;然后重启路由，在SecureCRT中看到如下信息的时候&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;U-Boot 1.1.4 (Jun 20 2012 - 17:03:09)

AP121 (ar9330) U-boot

DRAM:  32 MB
led turning on for 1s...
id read 0x100000ff
flash size 4194304, sector count = 64
Flash:  4 MB
Using default environment
...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;迅速在键盘上敲下&lt;em&gt;tpl&lt;/em&gt;,要快，相当于电脑上按F12来进入BIOS. 
这个时候串口会停止打印, 并出现&lt;em&gt;hornet&amp;gt;&lt;/em&gt;,就表示进入了输入模式。&lt;/p&gt;

&lt;p&gt;在输入命令之前，回到电脑上下载安装好TFTP软件, 然后选择共享文件夹为比如&lt;em&gt;桌面/openwrt&lt;/em&gt;，在这个文件夹下放入下载好的&lt;a href=&quot;http://service.tp-link.com.cn/detail_download_918.html&quot;&gt;原厂固件wr720nv3&lt;/a&gt;。&lt;/p&gt;

&lt;p&gt;回到SecureCRT中，按照如下步骤输入命令：&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;&lt;em&gt;hornet&amp;gt; setenv serverip 192.168.1.3&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;

    &lt;p&gt;这里设置TFTP服务器的地址，这样wr720nv3.bin可以被uboot访问到			&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;&lt;em&gt;hornet&amp;gt; tftpboot 0x80000000 wr720nv3.bin&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;

    &lt;p&gt;这里wr720nv3就是tftp共享的文件名字,确保TFTP服务器打开状态
你应该可以看到如下输出：&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt;eth1 link down
Using eth0 device
TFTP from server 192.168.1.3; our IP address is 192.168.1.111
Filename &#39;720.bin&#39;.
Load address: 0x80000000
Loading: *.#################################################################
. #################################################################
. #################################################################
. #################################################################
. #################################################################
. #################################################################
. #################################################################
. #################################################################
. #################################################################
. #################################################################
. #################################################################
. ######################################################
done
Bytes transferred = 3932164 (3c0004 hex) 
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;&lt;em&gt;hornet&amp;gt;erase 0x9f020000 +0x3c0000&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt; First 0x2 last 0x3d sector size 0x10000
 ....   2....   3....   4....   5....   6....   7....   8....   9....  10....  11....  12....  13....  14....  15....  16....  17....  18....  19....  20....  21....  22....  23....  24....  25....  26....  27....  28....  29....  30....  31....  32....  33....  34....  35....  36....  37....  38....  39....  40....  41....  42....  43....  44....  45....  46....  47....  48....  49....  50....  51....  52....  53....  54....  55....  56....  57....  58....  59....  60....  61
 Erased 60 sectors
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;&lt;em&gt;hornet&amp;gt; cp.b 0×80000000 0x9f020000 0x3c0000&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;

    &lt;pre&gt;&lt;code&gt; Copy to Flash... write addr: 9f020000
 done
&lt;/code&gt;&lt;/pre&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;&lt;em&gt;hornet&amp;gt;bootm 0x9f020000&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;完整的命令是如下：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;setenv serverip 192.168.1.3
tftpboot 0x80000000 wr720nv3.bin
erase 0x9f020000 +0x3c0000
cp.b 0x80000000 0x9f020000 0x3c0000
bootm 0x9f020000
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;基本上刷机完成。&lt;/p&gt;

&lt;h4 id=&quot;section-5&quot;&gt;4. 验证&lt;/h4&gt;

&lt;p&gt;怎么验证是否成功了？ 重启路由，插入网线，连接无线网络（好像是TP-Link-MXXXX不记得了）， 输入192.168.1.253。&lt;/p&gt;

&lt;p&gt;登进去就说明没什么问题了，修好了, 修砖完成。&lt;/p&gt;

&lt;h5 id=&quot;section-6&quot;&gt;引用&lt;/h5&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;http://www.sl088.com/voyage/2012/03/3197.slboat&quot;&gt;TP-LINK WR703 内部和TTL BY ONIONISMINE@不小心刷坏、船长@估算TTL&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://www.right.com.cn/forum/thread-100003-1-1.html&quot;&gt;TP-720N (v3 Flash为4M) 修砖记录&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

</content>
 </entry>
 
 <entry>
   <title>UrbanAirship Android Received push with invalid authorization on platform GCM</title>
   <link href="http://tuohuang.info/urbanairship-android-received-push-with-invalid-authorization-on-platform-gcm"/>
   <updated>2014-03-19T20:46:47+08:00</updated>
   <id>http://tuohuang.info/urbanairship-android-received-push-with-invalid-authorization-on-platform-gcm</id>
   <content type="html">&lt;p&gt;I was trying integrate Urban Airship to an android application so that I could send push notification to all registered android devices via Google’s &lt;a href=&quot;http://developer.android.com/google/gcm/index.html&quot;&gt;GCM&lt;/a&gt; (Google Cloud Messaging for Android) service.&lt;/p&gt;

&lt;p&gt;Urban Airship does have a really good documentation about to how to set it up on Android: &lt;a href=&quot;http://docs.urbanairship.com/build/android.html#setting-up-gcm-support-for-your-app&quot;&gt;Android: Getting Started with Push&lt;/a&gt;. So I followed the instruction above and integrated with android app locally. But when I try to test the push notification by going to &lt;em&gt;Messages&lt;/em&gt; -&amp;gt; &lt;em&gt;Test Push&lt;/em&gt; in the left panel like following screenshot &lt;img src=&quot;http://farm8.staticflickr.com/7155/13265323853_a0189bc83b_b.jpg&quot; alt=&quot;Invalid Authorization on GCM&quot; /&gt;.&lt;/p&gt;

&lt;p&gt;It keeps saying &lt;strong&gt;Received push with invalid authorization on platform GCM&lt;/strong&gt;.&lt;/p&gt;

&lt;h2 id=&quot;problem-breakdown&quot;&gt;Problem breakdown&lt;/h2&gt;

&lt;p&gt;I searched in google and found several same issues reported by people, e.g., &lt;a href=&quot;https://support.urbanairship.com/customer/portal/questions/4449356-received-push-with-invalid-authorization-on-platform-gcm-in-urban-push-console&quot;&gt;Received push with invalid authorization on platform GCM in Urban push console&lt;/a&gt; and  &lt;a href=&quot;https://support.urbanairship.com/customer/portal/questions/4690667-received-push-with-invalid-authorization-on-platform-gcm&quot;&gt;Received push with invalid authorization on platform GCM&lt;/a&gt;. The thing is that it works fine on iOS but not on Android, the kind-hearted guy from Urban Airship suggested to look through their &lt;a href=&quot;https://support.urbanairship.com/customer/portal/articles/823114-gcm-troubleshooting-guide&quot;&gt;GCM Troubleshooting Guide&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;Well, I did verify each steps illustrated in the troubleshooting guide, the api key, package, sender id and so on. Still no clue for it.I take a step back and think the problem clearly refers to “invalid authroization on platform GCM”, then it should be something wrong with GCM settings.&lt;/p&gt;

&lt;p&gt;Here is the settings in google api console:&lt;img src=&quot;http://farm4.staticflickr.com/3756/13265170335_69a45bd164_b.jpg&quot; alt=&quot;Google API Console&quot; /&gt;&lt;/p&gt;

&lt;p&gt;There is SHA1 string and a package name for it, you have to make sure you have right SHA1 and package name from your app. Based on the documentation about &lt;a href=&quot;https://developers.google.com/console/help/new/#usingkeys&quot;&gt;Keys, access, security, and identity&lt;/a&gt;. I need doublec check the apk generated should have same SHA1 and package name. To verify the SHA1 string, there is post in stackoverflow &lt;a href=&quot;http://stackoverflow.com/questions/11331469/how-to-find-out-which-key-was-used-to-sign-an-app&quot;&gt;How to find out which key was used to sign an app?&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;

  &lt;pre&gt;&lt;code&gt;2:35 ~/Desktop/frames/PushSample-debug-unaligned/META-INF $ keytool -printcert -file CERT.RSA
Owner: CN=Android Debug, O=Android, C=US
Issuer: CN=Android Debug, O=Android, C=US
Serial number: 517787d8
Valid from: Wed Apr 24 15:20:56 CST 2013 until: Fri Apr 17 15:20:56 CST 2043
Certificate fingerprints:
	 MD5:  9C:DC:4C:FA:5A:74:F0:83:9D:17:D8:3B:1A:C3:BD:E5
	 SHA1: 34:10:4F:F9:9D:63:7A:56:BE:94:AD:07:B3:80:3B:A1:EE:9A:E6:67
	 Signature algorithm name: SHA1withRSA
	 Version: 3
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;

&lt;p&gt;and compare with the SHA1 string in &lt;em&gt;~/.android/debug.keystore&lt;/em&gt;:&lt;/p&gt;

&lt;blockquote&gt;

  &lt;pre&gt;&lt;code&gt;12:36 ~/Desktop/frames/PushSample-debug-unaligned/META-INF $ keytool -list -keystore ~/.android/debug.keystore
Enter keystore password:android	
Keystore type: JKS
Keystore provider: SUN	
Your keystore contains 1 entry	
androiddebugkey, Apr 24, 2013, PrivateKeyEntry,
Certificate fingerprint (MD5): 9C:DC:4C:FA:5A:74:F0:83:9D:17:D8:3B:1A:C3:BD:E5
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;

&lt;p&gt;The SHA1 string is the same, then how about the package name? &lt;/p&gt;

&lt;p&gt;Refer to this post &lt;a href=&quot;http://stackoverflow.com/questions/6289149/resolving-the-package-name-of-android-apk&quot;&gt;Resolving the package name of Android APK&lt;/a&gt;, I’m able to print the apk infos about package name:&lt;/p&gt;

&lt;blockquote&gt;

  &lt;pre&gt;&lt;code&gt;12:40 ~/Desktop/frames $ /Users/tuo/Documents/SDKS/adt-bundle-mac-x86_64-20131030/sdk/build-tools/android-4.4/aapt  dump badging PushSample-debug-unaligned.apk
package: name=&#39;com.reigndesign.rdapp1&#39; versionCode=&#39;1&#39; versionName=&#39;1.0&#39;
sdkVersion:&#39;7&#39;
targetSdkVersion:&#39;19&#39;
uses-permission:&#39;android.permission.INTERNET&#39;
...
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;

&lt;p&gt;Also the package name matches.&lt;/p&gt;

&lt;p&gt;Here is the question the package name and SHA1 are correct, then how come it still says “&lt;em&gt;invalid authorization&lt;/em&gt;” ?	&lt;/p&gt;

&lt;h2 id=&quot;android-key-vs-server-key&quot;&gt;Android key vs Server key&lt;/h2&gt;

&lt;p&gt;My instinct that accumulated from countless red-eye days of programming told me that I should rollback everything and start walk through the documentation as carefully as I can from scratch.&lt;/p&gt;

&lt;p&gt;And I did find out why.&lt;/p&gt;

&lt;p&gt;In one section about &lt;a href=&quot;http://docs.urbanairship.com/build/android.html#get-your-api-key-from-google&quot;&gt;Get your API Key from Google&lt;/a&gt;, it says:&lt;/p&gt;

&lt;blockquote&gt;

  &lt;pre&gt;&lt;code&gt;4.Generate an API Key	
	A. Click on the text where it says “Google Cloud Messaging for Android” in the image above.		
	B. This takes your to the Google APIs page. Click on API Access.		
	C. Urban Airship takes care of API Access authorization for you, so you do not need to create an OAuth 2.0 client ID.		
	D. Click on “Create a new Server key...” to generate your API Key.		
	E. Do not specify any IP addresses in the form, and click “Create”
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;

&lt;p&gt;What I realized is that holy &lt;em&gt;**&lt;/em&gt;, it is god dammned &lt;em&gt;Server key&lt;/em&gt; instead of &lt;em&gt;Android key&lt;/em&gt;. I did go back and take a detail look at what android key is about:&lt;/p&gt;

&lt;blockquote&gt;

  &lt;pre&gt;&lt;code&gt;Create an Android key and configure allowed Android applications
	This key can be deployed in your Android application. API requests are sent directly to Google from your client Android device. Google verifies that each request originates from an Android application that matches one of the certificate SHA1 fingerprints and package names listed below. You can discover the SHA1 fingerprint of your developer certificate using the following command:
	keytool -list -v -keystore mystore.keystore
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;

&lt;p&gt;Then I understand it better. Because ubarn airship is acting on our app’s behalf dealing with GCM platform rather than let our app do the dirty job. So serve key makes sense to me now.&lt;/p&gt;

&lt;p&gt;So I created a &lt;em&gt;Server key&lt;/em&gt; and try it again, no more errors.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://farm8.staticflickr.com/7224/13265325123_72842e53a3_b.jpg&quot; alt=&quot;Server key&quot; /&gt;&lt;/p&gt;

</content>
 </entry>
 
 <entry>
   <title>GPUImage Photo(Still)/Video - Color Degradation/Too Much Brightness</title>
   <link href="http://tuohuang.info/gpuimage-color-degradation"/>
   <updated>2014-03-02T13:29:59+08:00</updated>
   <id>http://tuohuang.info/gpuimage-color-degradation</id>
   <content type="html">&lt;p&gt;I have mentioned this problem before in my previous post &lt;a href=&quot;http://tuohuang.info/gpuimage_movie_writer_exposure_problem&quot;&gt;GPUImage Movie Writer Exposure Problem&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I thought I have solved problem but still the color rendered in GPUImageView is weird - it doesn’t look that much nature. I re-examine the change and find there is some sample code called &lt;a href=&quot;https://developer.apple.com/library/ios/samplecode/GLCameraRipple/Introduction/Intro.html&quot;&gt;GLCameraRipple&lt;/a&gt; from Apple which pretty much does same thing - color conversion from YUV to RGB.&lt;/p&gt;

&lt;p&gt;After I download and check the code in GLCameraRipple, I find that actually the shader is pretty much the same. I changed the shader string to what I mentioned in &lt;a href=&quot;http://tuohuang.info/gpuimage_movie_writer_exposure_problem&quot;&gt;GPUImage Movie Writer Exposure Problem&lt;/a&gt;, tried it out but the rendered image still isn’t right. &lt;/p&gt;

&lt;p&gt;Then I trace from shader string down to the configurations/settings of the OpenGL ES, more specifically the texture uploading. &lt;/p&gt;

&lt;p&gt;Here are the code in GPUImageVideoCamera.m: &lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;objectivec&quot;&gt; 
&lt;span class=&quot;c1&quot;&gt;// Y-plane&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;glActiveTexture&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GL_TEXTURE4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GPUImageContext&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;deviceSupportsRedTextures&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//                err = CVOpenGLESTextureCacheCreateTextureFromImage(kCFAllocatorDefault, coreVideoTextureCache, cameraFrame, NULL, GL_TEXTURE_2D, GL_RED_EXT, bufferWidth, bufferHeight, GL_RED_EXT, GL_UNSIGNED_BYTE, 0, &amp;amp;luminanceTextureRef);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CVOpenGLESTextureCacheCreateTextureFromImage&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kCFAllocatorDefault&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;coreVideoTextureCache&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cameraFrame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;GL_TEXTURE_2D&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;GL_LUMINANCE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bufferWidth&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bufferHeight&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;GL_LUMINANCE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;GL_UNSIGNED_BYTE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;luminanceTextureRef&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CVOpenGLESTextureCacheCreateTextureFromImage&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kCFAllocatorDefault&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;coreVideoTextureCache&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cameraFrame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;GL_TEXTURE_2D&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;GL_LUMINANCE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bufferWidth&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bufferHeight&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;GL_LUMINANCE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;GL_UNSIGNED_BYTE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;luminanceTextureRef&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;You would probably wonder why those two code in both branches is the same.As you see, the only difference is that &lt;strong&gt;GL_RED_EXT&lt;/strong&gt; vs &lt;strong&gt;GL_LUMINANCE&lt;/strong&gt;. Then I’m curious about which value is used in apple’s sample code. &lt;/p&gt;

&lt;p&gt;Open file &lt;a href=&quot;https://developer.apple.com/library/ios/samplecode/GLCameraRipple/Listings/GLCameraRipple_RippleViewController_m.html#//apple_ref/doc/uid/DTS40011222-GLCameraRipple_RippleViewController_m-DontLinkElementID_8&quot;&gt;RippleViewController.m&lt;/a&gt;, scroll down then you can see the following code snippet:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;objectivec&quot;&gt; 
&lt;span class=&quot;c1&quot;&gt;// CVOpenGLESTextureCacheCreateTextureFromImage will create GLES texture&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// optimally from CVImageBufferRef.&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// Y-plane&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;glActiveTexture&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GL_TEXTURE0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CVOpenGLESTextureCacheCreateTextureFromImage&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kCFAllocatorDefault&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
                                                   &lt;span class=&quot;n&quot;&gt;_videoTextureCache&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                                                   &lt;span class=&quot;n&quot;&gt;pixelBuffer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                                                   &lt;span class=&quot;nb&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                                                   &lt;span class=&quot;n&quot;&gt;GL_TEXTURE_2D&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                                                   &lt;span class=&quot;n&quot;&gt;GL_RED_EXT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                                                   &lt;span class=&quot;n&quot;&gt;_textureWidth&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                                                   &lt;span class=&quot;n&quot;&gt;_textureHeight&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                                                   &lt;span class=&quot;n&quot;&gt;GL_RED_EXT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                                                   &lt;span class=&quot;n&quot;&gt;GL_UNSIGNED_BYTE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                                                   &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                                                   &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_lumaTexture&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; 
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;NSLog&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;@&amp;quot;Error at CVOpenGLESTextureCacheCreateTextureFromImage %d&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;   
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;So the shader string is much the same, well the texture uploading settings is different. I tried to change all the settings in &lt;a href=&quot;https://github.com/BradLarson/GPUImage/blob/master/framework/Source/GPUImageVideoCamera.m&quot;&gt;GPUImageVideoCamera.m&lt;/a&gt; and &lt;a href=&quot;https://github.com/BradLarson/GPUImage/blob/master/framework/Source/GPUImageMovie.m&quot;&gt;GPUImageMovie.m&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Now run the app again, compare the image with previous one, this time it looks fine.&lt;/p&gt;

&lt;p&gt;The complete code change is in this commit: &lt;a href=&quot;https://github.com/tuo/GPUImage/commit/5176663ee22dd3e04e0a593247453f84565263fc&quot;&gt;fix color degradation&lt;/a&gt;.&lt;/p&gt;

</content>
 </entry>
 
 <entry>
   <title>GPUImage Merge Videos with Chroma Key - GPUImageMovieWriter Two Audio Tracks</title>
   <link href="http://tuohuang.info/gpuimage-merge-videos-with-chroma-key-gpuimagemoviewriter-two-audio-tracks"/>
   <updated>2014-02-16T09:38:51+08:00</updated>
   <id>http://tuohuang.info/gpuimage-merge-videos-with-chroma-key-gpuimagemoviewriter-two-audio-tracks</id>
   <content type="html">&lt;p&gt;Let’s continue second topic about &lt;code&gt;Merging videos with GPUImage&lt;/code&gt;: Writing both audio tracks of source videos to final output video.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;objectivec&quot;&gt; 
&lt;span class=&quot;p&quot;&gt;...&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gpuMovieA&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GPUImageMovie&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;alloc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;initWithURL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;..];&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gpuMovieFX&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GPUImageMovie&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;alloc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;initWithURL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;...];&lt;/span&gt;

&lt;span class=&quot;p&quot;&gt;...&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;movieWriter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;shouldPassthroughAudio&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;YES&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gpuMovieA&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;audioEncodingTarget&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;movieWriter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gpuMovieA&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;enableSynchronizedEncodingUsingMovieWriter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;movieWriter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;

&lt;span class=&quot;p&quot;&gt;...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;So you want to write audio track of one of two source video to destination video, above code would works quite well.&lt;/p&gt;

&lt;p&gt;For example, in above code we want to have audio of gpuMovieA video show up in final video. Then sometimes we found
that we need to merge two audio tracks in each source video into final output video.&lt;/p&gt;

&lt;p&gt;There are some issues in github about audio writing : &lt;a href=&quot;https://github.com/BradLarson/GPUImage/issues/934&quot;&gt;Audio writing issues with GPUImageMovieWriter&lt;/a&gt; and &lt;a href=&quot;https://github.com/BradLarson/GPUImage/issues/1223&quot;&gt;Merging of video and audio&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Someone in the issue mentioned with frustration:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;I gave up and wrote my own code. GPUImage is great but it has so many issues and the code is not very easy to read for openGL noobs like me.
I learned more by writing it myself - all roads lead to rome, and all of GPUImage is basically based on a few examples out there on the net anyhow..&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Well, Brad Larson has just commented to that request:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;There currently is no way to do this kind of audio mixing. Only one audio source is used at a time.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;problem-breakdown&quot;&gt;Problem Breakdown&lt;/h1&gt;

&lt;p&gt;Merging video tracks does work but audio doens’t is because the way how it works. For video tracks merging, there are two GPUImageMovie instances and each starts reading frames, uploading image buffer to GPU then grabbing the reference to rendered texture, passing to GPUImageMovieWriter instance. Then GPUImageMovieWriter bind references of two textures to chroma key shader’s input sample textures, rendered it. Finally grabbing the rendered output texture and write it to output video.&lt;/p&gt;

&lt;p&gt;However audio tracks works quite differently, as you couldn’t mix two CMSampleBufferRef of audio track output. How about in the GPUImageMovieWriter we use AVMutableComposition to mix two audio tracks and output it as a source for asset writer to write it to final output video.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;objectivec&quot;&gt; 
&lt;span class=&quot;k&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;startMixAudio&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
     &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rawVideoPath&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
         &lt;span class=&quot;c1&quot;&gt;//start reading&lt;/span&gt;
         &lt;span class=&quot;n&quot;&gt;NSURL&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;audioURL&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NSURL&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fileURLWithPath&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rawVideoPath&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
         &lt;span class=&quot;n&quot;&gt;NSURL&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;audioURL2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NSBundle&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mainBundle&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;URLForResource&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;@&amp;quot;BOOMi_Greet&amp;quot;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;withExtension&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;@&amp;quot;mp4&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
 
         &lt;span class=&quot;n&quot;&gt;AVURLAsset&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;audioAsset&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;AVURLAsset&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;alloc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;initWithURL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;audioURL&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
         &lt;span class=&quot;n&quot;&gt;AVURLAsset&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;audioAsset2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;AVURLAsset&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;alloc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;initWithURL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;audioURL2&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
 
 
         &lt;span class=&quot;n&quot;&gt;AVMutableComposition&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mixComposition&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;AVMutableComposition&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;composition&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
 
         &lt;span class=&quot;n&quot;&gt;AVMutableCompositionTrack&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;compositionCommentaryTrack&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mixComposition&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;addMutableTrackWithMediaType&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;AVMediaTypeAudio&lt;/span&gt;
                                                                                             &lt;span class=&quot;nl&quot;&gt;preferredTrackID:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kCMPersistentTrackID_Invalid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
         &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;compositionCommentaryTrack&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;insertTimeRange&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;CMTimeRangeMake&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kCMTimeZero&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;audioAsset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;duration&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
                                             &lt;span class=&quot;nl&quot;&gt;ofTrack:&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;audioAsset&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tracksWithMediaType&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;AVMediaTypeAudio&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objectAtIndex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
                                              &lt;span class=&quot;nl&quot;&gt;atTime:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kCMTimeZero&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
 
 
         &lt;span class=&quot;n&quot;&gt;AVMutableCompositionTrack&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;compositionAudioTrack&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mixComposition&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;addMutableTrackWithMediaType&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;AVMediaTypeAudio&lt;/span&gt;
                                                                                        &lt;span class=&quot;nl&quot;&gt;preferredTrackID:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kCMPersistentTrackID_Invalid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
         &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;compositionAudioTrack&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;insertTimeRange&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;CMTimeRangeMake&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kCMTimeZero&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;audioAsset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;duration&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
                                        &lt;span class=&quot;nl&quot;&gt;ofTrack:&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;audioAsset2&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tracksWithMediaType&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;AVMediaTypeAudio&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objectAtIndex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
                                         &lt;span class=&quot;nl&quot;&gt;atTime:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kCMTimeZero&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
 
 
 
 
         &lt;span class=&quot;c1&quot;&gt;// --- video reader&lt;/span&gt;
 
         &lt;span class=&quot;n&quot;&gt;AVAssetReader&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;assetReader&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;AVAssetReader&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;assetReaderWithAsset&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mixComposition&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
 
 
         &lt;span class=&quot;n&quot;&gt;AVAssetReaderAudioMixOutput&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;assetReaderTrackOutput&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
                 &lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;AVAssetReaderAudioMixOutput&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;alloc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;initWithAudioTracks&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mixComposition&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tracksWithMediaType&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;AVMediaTypeAudio&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
                                                            &lt;span class=&quot;nl&quot;&gt;audioSettings:&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
 
 
 &lt;span class=&quot;c1&quot;&gt;//        AVAssetTrack *assetTrack = [[mixComposition tracksWithMediaType:AVMediaTypeAudio] objectAtIndex:0];&lt;/span&gt;
 &lt;span class=&quot;c1&quot;&gt;//        AVAssetReaderTrackOutput *assetReaderTrackOutput = [AVAssetReaderTrackOutput assetReaderTrackOutputWithTrack:assetTrack outputSettings:NULL];&lt;/span&gt;
         &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;assetReader&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;addOutput&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;assetReaderTrackOutput&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
         &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;assetReader&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;startReading&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
 
 
         &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;assetWriterAudioInput&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;requestMediaDataWhenReadyOnQueue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;movieWritingQueue&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;usingBlock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:^&lt;/span&gt;
         &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
             &lt;span class=&quot;n&quot;&gt;NSLog&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;@&amp;quot;Asset Writer ready :%d&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;assetWriterAudioInput&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;readyForMoreMediaData&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
 
             &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;assetWriterAudioInput&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;readyForMoreMediaData&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;audioEncodingIsFinished&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
             &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                 &lt;span class=&quot;n&quot;&gt;CMSampleBufferRef&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nextBuffer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
 
                 &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;assetReader&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;status&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;AVAssetReaderStatusReading&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nextBuffer&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;assetReaderTrackOutput&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;copyNextSampleBuffer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]))&lt;/span&gt;
                 &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                     &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nextBuffer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
                     &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                         &lt;span class=&quot;n&quot;&gt;NSLog&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;@&amp;quot;append buffer NextBuffer&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
                         &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;assetWriterAudioInput&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;appendSampleBuffer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nextBuffer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
                     &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
                 &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
 
                 &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
                 &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                     &lt;span class=&quot;n&quot;&gt;NSLog&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;@&amp;quot;audio wrint done&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
                     &lt;span class=&quot;n&quot;&gt;audioEncodingIsFinished&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;YES&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
                     &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;assetWriterAudioInput&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;markAsFinished&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
                 &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
             &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
         &lt;span class=&quot;p&quot;&gt;}];&lt;/span&gt;
     &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
 
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;To see more details on this , you can check my commit on github: &lt;a href=&quot;https://github.com/tuo/GPUImage/commit/94dd95a650e076dd5c5a4e1be5e01020acd44928&quot;&gt;Writing Two Audio Tracks&lt;/a&gt;&lt;/p&gt;
</content>
 </entry>
 
</feed>
