
<!doctype html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--> 	
<html lang="en"> 
<!--<![endif]-->
  <head>
    <meta charset="utf-8" />
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />	<!-- Force Latest IE rendering engine -->
    <title>TPLink WR720N刷OpenWrt - 修砖</title>

    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->


    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
    <link href="http://feeds2.feedburner.com/tu0huang" rel="alternate" title="Tuo" type="application/atom+xml" /> 
    <link rel="shortcut icon" href="/static/images/favicon.png" />

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 

    <link rel="stylesheet" href="/static/css/style.css">

    <!--[if IE 7]>
      <script src="/static/css/font-awesome-ie7.css"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">	
     

      <article class='fourteen columns' id="article-content" style="border: 0px solid red">

  <a id="avatar" class="four columns" style="width:100px;height:100px;" href="/"></a>

  <header class="eleven columns" id="article-header" style="margin-top:14px;">
    <h1>TPLink WR720N刷OpenWrt - 修砖</h1>
  </header>

  <div class='eleven columns gray' id="date-header" style="margin-bottom: 10px;">
    <p>
      May 04, 2014
    </p>

  </div>

  <div style="clear:both"/>
  <div class="fourteen columns" id="article-content">
    <p>    一年一度的NBA季后赛开始了，今年季后赛第一轮更是尤其精彩，连续两天五场抢七，还有惊心动魄的火箭打开拓者，看的我这个篮球迷如痴如醉。但是比赛一般都在早上，而且比赛时间还挺长的，如果看完了再去上班肯定稳稳的迟到，如果晚上回来想看录像了又觉得网速那个点又慢，而且我对国内的解说说实话也不是感冒，看英文的可能还舒服点，没那么吵吵。所以我希望在比赛结束了（一般都是中午左右）， 在上班的间隙我把种子下好，然后上传到比如我家里路由器暴露在外面上某个网址上，可以利用迅雷下载的速度优势，在下班回家前就把高清录像下好了。我回到家里的时候，直接从电脑上stream路由器的存储媒介（通常是硬盘）上下好的视频。</p>

<p>    选路由器是因为我不可能把家里的笔记本一直开一天吧，这个也太浪费了把。而且路由器本来就是在那开一天的，倒也不浪费。所以怎么捯饬这玩意可以达到我上面美好的愿望了？就是<em><a href="http://openwrt.org/">OpenWrt</a></em>了。简单的说，我将要干的事情就是把路由器出厂自带的固件也换成Openwrt。我发现网上有不少关于这方面的教程（大部分还是703N，有点老了），但是没有讲的很清楚从头到尾很直白的那种，这篇博客就是记录自己刷机的过程</p>

<h2 id="section">首次刷机尝试</h2>

<p>    手头有的东西名目:</p>

<pre><code>* 一个很早之前买的TPLink WR720N迷你路由
* 一根microUSB线
* 网线
</code></pre>

<p>    那选择WR720N也是因为首先它便宜啊，而且它自带一个USB口(方便挂载外设），一个microUSB口，一个LAN口，还有一个WAN/LAN口， 真实麻雀虽小，五脏俱全。</p>

<p><img src="https://farm8.staticflickr.com/7383/13916298737_4feb69fda5_b.jpg" alt="TPLink WR720N" /></p>

<p>    而且Openwrt官方已经添加了对WR720N专有固件的支持(你可以找到openwrt支持的所有硬件列表<a href="http://wiki.openwrt.org/toh/start">Table of Hardware - Router type</a>)，使得刷机愈加容易。你需要做的就是去这个地址<a href="http://downloads.openwrt.org/snapshots/trunk/ar71xx/">http://downloads.openwrt.org/snapshots/trunk/ar71xx/</a>找到<a href="http://downloads.openwrt.org/snapshots/trunk/ar71xx/openwrt-ar71xx-generic-tl-wr720n-v3-squashfs-factory.bin">openwrt-ar71xx-generic-tl-wr720n-v3-squashfs-factory.bin</a>和<a href="http://downloads.openwrt.org/snapshots/trunk/ar71xx/openwrt-ar71xx-generic-tl-wr720n-v3-squashfs-sysupgrade.bin">openwrt-ar71xx-generic-tl-wr720n-v3-jffs2-sysupgrade.bin</a>，然后下载到本地。</p>

<p>    接下来就是登陆路由器,720N就是192.168.1.253,然后找到左侧最下面的<em>升级</em>，选取将本地刚刚下好的factory.bin(不是sysupgrade.bin)）升级,耐心等重启之后就可以了。</p>

<p>    为什么这里是factory而不是sysupgrade了？ <a href="http://wiki.openwrt.org/doc/faq/before.installation">FAQ before installing OpenWrt</a></p>

<blockquote>
  <p>What is the difference between the different image formats?</p>

  <p>a factory image is one built for the bootloader flasher or stock software flasher</p>

  <p>sysupgrade image (previously named trx image) is designed to be flashed from within openwrt itself</p>
</blockquote>

<h2 id="section-1">刷成砖头了</h2>
<p>    是的，应该很简单，应该木有问题的，但是很不幸我的刷成了砖头了，ping不通，IP地址无效，重设了N遍都木有任何反应。<img class="emoji" title=":scream:" alt=":scream:" src="https://assets.github.com/images/icons/emoji/scream.png" height="20" width="20" align="absmiddle" /> </p>

<p>    怎么办了？我大概了解下路由器启动过程，一般路由器都有一个Flash卡（相当于电脑的硬盘，里面有你个操作系统文件等等），里面有你写好或者下好的固件.当路由器启动时，有一个启动引导程序uboot（相当于windows上BIOS),一般来收它会从Flash卡读取固件（相当于windows比如默认从硬盘上启动操作系统）并加载到内存中。</p>

<p>    这里就是一般来说就是Flash卡中的固件已经损坏了，我们需要擦除里面已有固件信息，然后将原厂固件刷进去。但是这个怎么操作了，我们都进不去路由？</p>

<h2 id="ttl">TTL修砖</h2>
<p>    除了砸了之外还是有办法挽救的 - TTL线。 我也不太清楚这个具体原理，大概就是你需要找到路由器板子上的两个接口TP_IN和TP_OUT(可以用来接受和发送指令),这里相当于外设，然后与电脑(COM)进行串口通信。</p>

<p>    但是笔记本木有COM端口了，需要将USB转换成COM端口，然后与路由器电路板上连接，接着使用串口通信的软件设置对应的串口号以及波特率，这样就可以发送指令到路由器电路板，从而修复固件。</p>

<p>我们需要的东西:</p>

<pre><code>* USB转串口的TTL线, 可以从淘宝上买[USB转TTL模块](http://item.taobao.com/item.htm?_u=tc8grg404cf&amp;id=14126761542)）
* 电烙铁 
* 杜邦线（用于焊接和连接USB模块）
</code></pre>

<p>就可以了。</p>

<p><img src="https://farm6.staticflickr.com/5335/14079877556_66a2f80fae.jpg" alt="杜邦线" />
<img src="https://farm6.staticflickr.com/5348/13916363779_02f40ab666_z.jpg" alt="电烙铁" /></p>

<h4 id="section-2">1. 接线</h4>
<p>接下来就是拆机找到TP_IN和TP_OUT两个引脚。这个拆机还真有点技巧性。因为720N这个塑料外壳还真是一次性的，用蛮力的话盒子就没法用了，那么就不能插电源充电了，就只能是用microusb线充电了。但是因为引脚实在板子背面所以我们必须要将板子取出来。我想了一个办法就是拿烧红的刀直接去砍网口那边的两侧，这样一来板子可以取出来而且以后要是弄好了我还可以放回去，插电源充电也木有问题。
<img src="https://farm8.staticflickr.com/7067/13916324949_fc86e9ee3a_b.jpg" alt="TPLink WR720N BREAK IT DOWN" /></p>

<p>成功拆机了。</p>

<p><img src="https://farm6.staticflickr.com/5189/14099740901_82e05a8d63_b.jpg" alt="WR720N breakitdown" /></p>

<p>如果你仔细看背面中间，就可以发现TP_IN和TP_OUT连个引脚，但是它们都非常小，这就使得焊接非常难。
<img src="https://farm8.staticflickr.com/7327/14102965995_cf8dd4b512_b.jpg" alt="TP_IN AND TP_OUT" />			
使用电烙铁小心将杜邦线焊接到这两个接口上，另外一根线作为接地线GND随意焊接到哪都行，图方便的话直接焊接到USB接口外壳上也可以。</p>

<p>最后将引出的杜邦线连接到USB转TTL模块上。这里USB模块上写着<em>黑GND, 白RXD,绿TXD</em>.我们要做就是将引出的<em>TP_IN</em>针连接到<em>白RXD</em>上， <em>TP_OUT</em>连接到<em>绿TXD</em>口上。</p>

<p><img src="https://farm3.staticflickr.com/2933/13916358019_05c50fcd55_c.jpg" alt="wired" />
<img src="https://farm8.staticflickr.com/7305/14103410134_f3715bfef0_c.jpg" alt="wired gnd" />
注意注意：千万别将TP_IN或者TP_OUT连接到VCC口上，不然直接就把板子给烧了。（我去，我最后不小心看花眼连接错了直接把板子给烧了，是的，程序员不能在困的时候干正事）</p>

<h4 id="section-3">2. 安装驱动</h4>
<p>你直接连接好线是不能直接用的，串口还是无法被识别出来。你需要下载对应的驱动，也就是PL2303 USB to TTL驱动， <a href="http://www.prolific.com.tw/US/ShowProduct.aspx?p_id=229&amp;pcid=41">mac版</a>以及<a href="http://pan.baidu.com/s/1kTn1d6R">windows版</a>.</p>

<p>给路由器供电，这里我们使用microUSB来供电，接下来就是去<em>设备管理器</em>中查看<em>端口(COM和PT)</em>下面有没有东西，如果有类似于<em>Prolific USB-to-Serial Comm port(COM4)</em>，就表示识别成功。然后点击<em>属性</em>将其波特率改成<em>115200</em>.</p>

<p><img src="https://farm8.staticflickr.com/7395/13916387869_aa8288539c_c.jpg" alt="linked" /></p>

<h4 id="section-4">3. 调试</h4>
<p>到这一步就差不多可以干正事了，我们可以使用串口通信软件来发送指令来刷固件，这里用的是SecureCRT。很简单，我们创建一个串口连接，将其COM口设成设备管理器中显示的端口号，波特率设为115200.</p>

<p>拔掉microUSB线，然后重新连上，你就可以看到SecureCRT中开始滚动了，你应该可以看到如下信息，没有反应的话，检查你得rx/tx是否接反了。</p>

<p>是的，我们看到了uboot的引导信息。接下来就是怎么样打断其正常引导过程，因为Flash卡中的固件已经损坏了。但是我们不可能把Flash卡拔下来，把原厂库件刷进入，然后插回去重启。我们就需要告诉uboot从其他地方这里比如就是我们的电脑下载到flash卡中。 这里就可以配合tftp来实现从电脑上下载。为什么是tftp了？如果你后面进入了uboot输入模式，输入<em>help</em>就可以看到其中有一个选项：</p>

<pre><code>tftpboot- boot image via network using TFTP protocol
</code></pre>

<p>可以理解为TFTP是uboot能理解的轻量级FTP.</p>

<p>用网线一端连接路由器的WAN/LAN口，一端连接电脑。打开电脑,设置ip地址：</p>

<pre><code>IP: 192.168.1.3
Mask: 255.255.255.0
gateway/router: 空白 不要填 
</code></pre>

<p>然后重启路由，在SecureCRT中看到如下信息的时候</p>

<pre><code>U-Boot 1.1.4 (Jun 20 2012 - 17:03:09)

AP121 (ar9330) U-boot

DRAM:  32 MB
led turning on for 1s...
id read 0x100000ff
flash size 4194304, sector count = 64
Flash:  4 MB
Using default environment
...
</code></pre>

<p>迅速在键盘上敲下<em>tpl</em>,要快，相当于电脑上按F12来进入BIOS. 
这个时候串口会停止打印, 并出现<em>hornet&gt;</em>,就表示进入了输入模式。</p>

<p>在输入命令之前，回到电脑上下载安装好TFTP软件, 然后选择共享文件夹为比如<em>桌面/openwrt</em>，在这个文件夹下放入下载好的<a href="http://service.tp-link.com.cn/detail_download_918.html">原厂固件wr720nv3</a>。</p>

<p>回到SecureCRT中，按照如下步骤输入命令：</p>

<ol>
  <li>
    <p><strong><em>hornet&gt; setenv serverip 192.168.1.3</em></strong></p>

    <p>这里设置TFTP服务器的地址，这样wr720nv3.bin可以被uboot访问到			</p>
  </li>
  <li>
    <p><strong><em>hornet&gt; tftpboot 0x80000000 wr720nv3.bin</em></strong></p>

    <p>这里wr720nv3就是tftp共享的文件名字,确保TFTP服务器打开状态
你应该可以看到如下输出：</p>

    <pre><code>eth1 link down
Using eth0 device
TFTP from server 192.168.1.3; our IP address is 192.168.1.111
Filename '720.bin'.
Load address: 0x80000000
Loading: *.#################################################################
. #################################################################
. #################################################################
. #################################################################
. #################################################################
. #################################################################
. #################################################################
. #################################################################
. #################################################################
. #################################################################
. #################################################################
. ######################################################
done
Bytes transferred = 3932164 (3c0004 hex) 
</code></pre>
  </li>
  <li>
    <p><strong><em>hornet&gt;erase 0x9f020000 +0x3c0000</em></strong></p>

    <pre><code> First 0x2 last 0x3d sector size 0x10000
 ....   2....   3....   4....   5....   6....   7....   8....   9....  10....  11....  12....  13....  14....  15....  16....  17....  18....  19....  20....  21....  22....  23....  24....  25....  26....  27....  28....  29....  30....  31....  32....  33....  34....  35....  36....  37....  38....  39....  40....  41....  42....  43....  44....  45....  46....  47....  48....  49....  50....  51....  52....  53....  54....  55....  56....  57....  58....  59....  60....  61
 Erased 60 sectors
</code></pre>
  </li>
  <li>
    <p><strong><em>hornet&gt; cp.b 0×80000000 0x9f020000 0x3c0000</em></strong></p>

    <pre><code> Copy to Flash... write addr: 9f020000
 done
</code></pre>
  </li>
  <li>
    <p><strong><em>hornet&gt;bootm 0x9f020000</em></strong></p>
  </li>
</ol>

<p>完整的命令是如下：</p>

<pre><code>setenv serverip 192.168.1.3
tftpboot 0x80000000 wr720nv3.bin
erase 0x9f020000 +0x3c0000
cp.b 0x80000000 0x9f020000 0x3c0000
bootm 0x9f020000
</code></pre>

<p>基本上刷机完成。</p>

<h4 id="section-5">4. 验证</h4>

<p>怎么验证是否成功了？ 重启路由，插入网线，连接无线网络（好像是TP-Link-MXXXX不记得了）， 输入192.168.1.253。</p>

<p>登进去就说明没什么问题了，修好了, 修砖完成。</p>

<h5 id="section-6">引用</h5>

<ul>
  <li><a href="http://www.sl088.com/voyage/2012/03/3197.slboat">TP-LINK WR703 内部和TTL BY ONIONISMINE@不小心刷坏、船长@估算TTL</a></li>
  <li><a href="http://www.right.com.cn/forum/thread-100003-1-1.html">TP-720N (v3 Flash为4M) 修砖记录</a></li>
</ul>


  </div>
  <hr style="visibility:hidden;"/>
  
  <!--<footer class="ten columns">
    <p id='follow'>
       Follow me on <a href="http://twitter.com/tu0huang">Twitter</a> &
       <a href="http://weibo.com/tu0huang">Weibo</a>	   
    </p>
  </footer> -->
</article>

<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style fourteen columns" style="margin-bottom: 11px;">
	<a class="addthis_counter addthis_pill_style"></a>
</div>
<script type="text/javascript">var addthis_config = {"data_track_addressbar":true};</script>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-50f9651243f1723a"></script>
<!-- AddThis Button END -->
<div style="margin-bottom:10px;"/>
<div id="disqus_thread" class="fourteen columns"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'tuo'; // required: replace example with your forum shortname  
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    </div>
  </body>
</html> 
